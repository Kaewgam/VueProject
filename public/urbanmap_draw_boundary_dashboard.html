<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UrbanMap ‚Äî Draw-on-Red Parcel Prototype (DOL WMS over Satellite)</title>
  <style>
    :root{
      --ink:#0f172a; --muted:#475569; --bg:#0b1220; --panel:#0f172a; --card:#0b1220;
      --brand:#0ea5e9; --accent:#10b981; --danger:#ef4444; --border:#1f2a44; --soft:#111827;
      --fg:#e5e7eb; --fgmuted:#94a3b8;
    }
    html,body{height:100%;margin:0}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--fg);}
    a{color:var(--brand);text-decoration:none}
    /* Layout: left dashboard, right map */
    .wrap{display:grid; grid-template-columns: 380px 1fr; height:100vh;}
    #map{position:relative;height:100%;width:100%}
    #clipSvg{position:absolute;inset:0;z-index:6000;pointer-events:none}
    .dash{background:var(--panel);border-right:1px solid var(--border);display:flex;flex-direction:column;min-width:320px}
    .dash header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,rgba(14,165,233,.08),transparent)}
    .brand{display:flex;align-items:center;gap:10px}
    .brand .logo{width:28px;height:28px;border-radius:8px;background:var(--brand)}
    .brand strong{letter-spacing:.2px}
    .coins{display:flex;align-items:center;gap:10px}
    .coins .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border:1px solid var(--border);border-radius:999px;background:var(--soft);font-size:12px}
    .coins strong{font-variant-numeric:tabular-nums}
    .btn{padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:#0b1220;color:var(--fg);cursor:pointer}
    .btn.primary{background:var(--brand);border-color:#0284c7;color:#fff}
    .btn.accent{background:var(--accent);border-color:#059669;color:#00150f}
    .btn.danger{background:var(--danger);border-color:#b91c1c;color:#fff}
    .btn.ghost{background:#0b1220;border-color:var(--border)}
    .btn:active{transform:translateY(1px)}
    .muted{color:var(--fgmuted)}
    .section{padding:12px 14px;border-bottom:1px solid var(--border)}
    .row{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin:6px 0}
    .field{display:grid;grid-template-columns:120px 1fr;gap:8px;align-items:center;margin:8px 0}
    .field input, .field select, .field textarea{width:100%;padding:8px;border:1px solid var(--border);border-radius:8px;background:#0b1220;color:var(--fg)}
    .pill{padding:2px 8px;border:1px solid var(--border);border-radius:999px;background:#0b1220;font-size:12px}
    .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;padding:2px 6px;border:1px solid var(--border);border-radius:6px;background:#0b1220;color:var(--fgmuted)}
    .tabbar{display:flex;border-bottom:1px solid var(--border)}
    .tabbar button{flex:1;padding:10px;border:0;border-right:1px solid var(--border);background:#0b1220;color:var(--fg);cursor:pointer}
    .tabbar button.active{background:#0d1b2a}
    .tab{display:none;padding:12px 14px;overflow:auto}
    .tab.active{display:block}
    .list{display:grid;gap:8px}
    .card{border:1px solid var(--border);border-radius:12px;background:#0b1220;padding:10px 12px}
    .small{font-size:12px}
    .masked{filter:blur(5px)}
    .status{white-space:pre-line;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;max-height:120px;overflow:auto;background:#0b1220;border:1px solid var(--border);border-radius:8px;padding:8px}
    .ok{color:#34d399}.warn{color:#f59e0b}.err{color:#ef4444}
    .footer{margin-top:auto;padding:10px 14px;border-top:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;gap:10px}
    #permalink{width:52%;background:#0b1220;border:1px solid var(--border);color:var(--fg);padding:6px;border-radius:8px}
    /* Edge chooser */
    .edges{display:flex;gap:6px;flex-wrap:wrap}
    .edge{padding:4px 8px;border:1px solid var(--border);border-radius:8px;cursor:pointer}
    .edge.selected{background:rgba(16,185,129,.2);border-color:#10b981}
    /* Floating toolbar on map */
    .toolbar{position:absolute;top:12px;right:12px;z-index:7000;background:#0b1220;border:1px solid var(--border);border-radius:12px;padding:8px 10px;display:flex;gap:8px;align-items:center}
    .toolbar label{font-size:12px;color:var(--fgmuted)}
  </style>
</head>
<body>
  <div class="wrap">
    <aside class="dash">
      <header>
        <div class="brand">
          <div class="logo"></div>
          <strong>UrbanMap ‚Äî Draw Parcel</strong>
        </div>
        <div class="coins">
          <span class="chip">Coins: <strong id="coinBal">0</strong></span>
          <button class="btn accent" id="buyCoins">‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç</button>
        </div>
      </header>

      <div class="section">
        <div class="row">
          <span class="pill">‡∏ê‡∏≤‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</span>
          <select id="baseSel">
            <option value="SATELLITE" selected>Satellite</option>
            <option value="HYBRID">Hybrid</option>
            <option value="NORMAL">Road</option>
            <option value="GRAY">Gray</option>
          </select>
          <span class="pill">Overlay</span>
          <label><input type="checkbox" id="toggleDol" checked /> DOL (WMS: dol)</label>
        </div>
        <div class="row">
          <span class="pill">Opacity</span>
          <input id="opacity" type="range" min="0" max="100" value="85" />
          <span id="opv" class="small">0.85</span>
        </div>
        <div class="row"><span class="small">‡∏ß‡∏≤‡∏î‡∏ó‡∏±‡∏ö‡πÄ‡∏™‡πâ‡∏ô <b>‡πÅ‡∏î‡∏á</b> ‡∏à‡∏≤‡∏Å‡∏ä‡∏±‡πâ‡∏ô DOL ‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î <span class="kbd">Finish</span></span></div>
        <div class="row">
          <button id="centerBkk" class="btn ghost">Center: Bangkok</button>
          <button id="reloadApi" class="btn">Reload API</button>
          <span class="small">Engine: <span id="engineBadge" class="kbd">-</span></span>
        </div>
      </div>

      <div class="tabbar">
        <button id="tab-parcels" class="active">Dashboard</button>
        <button id="tab-gfi">GetFeatureInfo</button>
        <button id="tab-log">Status</button>
      </div>

      <section id="pane-parcels" class="tab active">
        <div class="row"><button id="startTrace" class="btn primary">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏≤‡∏î‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï</button><button id="finishTrace" class="btn">Finish</button><button id="clearSel" class="btn danger">Clear</button></div>
        <div class="row">
          <span class="pill">Snap to red</span>
          <label class="small">Red ‚â•</label><input id="redMin" type="number" value="180" min="0" max="255" style="width:72px">
          <label class="small">Green ‚â§</label><input id="greenMax" type="number" value="90" min="0" max="255" style="width:72px">
          <label class="small">Blue ‚â§</label><input id="blueMax" type="number" value="90" min="0" max="255" style="width:72px">
          <label class="small"><input type="checkbox" id="snapToggle" checked> ‡πÉ‡∏ä‡πâ Snap</label>
        </div>

        <div class="card">
          <h4 style="margin:0 0 6px">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏õ‡∏•‡∏á (‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)</h4>
          <div id="parcelSummary" class="small muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏î/‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏õ‡∏•‡∏á</div>
          <div class="field"><label>‡∏Ç‡∏ô‡∏≤‡∏î‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô (‡∏ï‡∏£.‡∏ß‡∏≤)</label><input id="f-area" type="number" min="0" placeholder="‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à" /></div>
          <div class="field"><label>‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏ß‡πâ‡∏≤‡∏á (‡πÄ‡∏°‡∏ï‡∏£)</label><input id="f-width" type="number" min="0" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏™‡πâ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á" /></div>
          <div class="row">
            <div class="pill">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏™‡πâ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏ß‡πâ‡∏≤‡∏á</div>
            <div id="edges" class="edges"></div>
          </div>
          <hr style="border-color:var(--border)">
          <div class="field"><label>‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á</label><input id="f-owner" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‚Äì‡∏™‡∏Å‡∏∏‡∏•" /></div>
          <div class="field"><label>‡πÇ‡∏ó‡∏£</label><input id="f-phone" type="text" placeholder="08x-xxx-xxxx" /></div>
          <div class="field"><label>LINE ID</label><input id="f-line" type="text" placeholder="@lineid ‡∏´‡∏£‡∏∑‡∏≠ lineid" /></div>
          <div class="row">
            <button id="reqPerm" class="btn">‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ú‡∏¢</button>
            <button id="simApprove" class="btn ghost">[‡πÄ‡∏î‡πÇ‡∏°] ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
            <button id="saveParcel" class="btn primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏õ‡∏•‡∏á</button>
          </div>
        </div>

        <div class="card" style="margin-top:10px">
          <h4 style="margin:0 0 6px">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏á</h4>
          <div id="parcelList" class="list"></div>
        </div>
      </section>

      <section id="pane-gfi" class="tab">
        <div class="small">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å GetFeatureInfo ‡∏à‡∏≤‡∏Å WMS</div>
        <pre id="gfiOut" class="status"></pre>
      </section>

      <section id="pane-log" class="tab">
        <div id="status" class="status">Loading‚Ä¶</div>
        <div class="row" style="margin-top:6px">
          <button id="runChecks" class="btn">Run Checks</button>
          <button id="testWms" class="btn">Test WMS</button>
        </div>
      </section>

      <div class="footer">
        <input id="permalink" class="small" readonly />
        <div class="row">
          <button id="copyLink" class="btn">Copy</button>
          <button id="openChat" class="btn">‡πÅ‡∏ä‡∏ó‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á (10 coins)</button>
          <button id="viewPII" class="btn">‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß (10 coins)</button>
        </div>
      </div>
    </aside>

    <main id="map" aria-label="Map area">
      <div class="toolbar">
        <label>Zoom & trace on red lines from DOL layer ‚Üí <span class="kbd">Finish</span></label>
      </div>
      <svg id="clipSvg" xmlns="http://www.w3.org/2000/svg">
        <path id="clipPath" d="" fill="rgba(255,255,255,0.55)" fill-rule="evenodd"></path>
      </svg>
    </main>
  </div>

  <script>
  (function(){
    // ===== Config =====
    const KEY='80000be3c85ad889339495dea206c691';
    const WMS='https://ms.longdo.com/mapproxy/service';
    const DOL='dol';
    const START={lat:13.7563, lon:100.5018, zoom:18};
    const CHAT_COST=10, PII_COST=10;

    // ===== State =====
    let engine=null; // 'longdo' | 'leaflet'
    let mapLD=null, layerDOL_LD=null, overlayLD=null;
    let mapLF=null, baseLF=null, layerDOL_LF=null, overlayLF=null;
    let tracing=false, tracePts=[], frontageIdx=null;
    let selectedId=null;

    // ===== Store (local) =====
    const store={
      get coins(){ return parseInt(localStorage.getItem('coins')||'0',10); },
      set coins(v){ localStorage.setItem('coins', String(v)); },
      list(){ try{return JSON.parse(localStorage.getItem('parcels')||'[]')}catch{return []} },
      save(list){ localStorage.setItem('parcels', JSON.stringify(list)); },
      upsert(p){ const L=this.list(); const i=L.findIndex(x=>x.id===p.id); if(i>=0) L[i]=p; else L.push(p); this.save(L); },
      byId(id){ return this.list().find(x=>x.id===id)||null; }
    };

    // ===== DOM =====
    const $=s=>document.querySelector(s);
    const statusEl=$('#status'), gfiOut=$('#gfiOut'), coinBal=$('#coinBal');
    const engineBadge=$('#engineBadge');
    const edgesEl=$('#edges'), parcelList=$('#parcelList'), parcelSummary=$('#parcelSummary');
    const clipSvg=$('#clipSvg'), clipPath=$('#clipPath');
    const setBadge=t=>engineBadge.textContent=t;
    function log(t,cls){ const d=document.createElement('div'); if(cls) d.className=cls; d.textContent=t; statusEl.appendChild(d); statusEl.scrollTop=statusEl.scrollHeight; }
    function setStatus(t,cls=''){ statusEl.textContent=''; log(t,cls); }

    // ===== Helpers =====
    const R=6378137, toRad=d=>d*Math.PI/180;
    function metersPerPixelAtLat(lat, z){ return (156543.03392804097*Math.cos(toRad(lat)))/Math.pow(2,z); }
    function lonLatToMerc({lon,lat}){ const x=R*(lon*Math.PI/180); const y=R*Math.log(Math.tan(Math.PI/4+(lat*Math.PI/180)/2)); return {x,y}; }
    function mercToLonLat({x,y}){ const lon=(x/R)*180/Math.PI; const lat=(Math.atan(Math.sinh(y/R)))*180/Math.PI; return {lat,lon}; }
    function uid(){ return 'P'+Math.random().toString(36).slice(2,9); }
    function polyAreaMeters2(poly){ if(!poly||poly.length<3) return 0; const pts=poly.map(lonLatToMerc); let a=0; for(let i=0,j=pts.length-1;i<pts.length;j=i++){ a+=(pts[j].x*pts[i].y - pts[i].x*pts[j].y);} return Math.abs(a/2); }
    function distMeters(a,b){ const A=lonLatToMerc(a), B=lonLatToMerc(b); return Math.hypot(A.x-B.x, A.y-B.y); }

    // ===== Longdo loader =====
    function loadLongdoScript(key){
      return new Promise((resolve,reject)=>{
        if(window.longdo && typeof window.longdo.Map==='function') return resolve('already');
        const ex=document.getElementById('longdo-api'); if(ex) ex.remove();
        const s=document.createElement('script'); s.id='longdo-api'; s.src='https://api.longdo.com/map/?key='+encodeURIComponent(key); s.async=true; s.defer=true;
        let done=false; const t=setTimeout(()=>{ if(!done){done=true; s.remove(); reject(new Error('Timeout loading Longdo API (15s). ‡∏ï‡∏£‡∏ß‡∏à whitelist/CSP')); }},15000);
        s.onload=()=>{ if(done) return; done=true; clearTimeout(t); (window.longdo&&window.longdo.Map)?resolve('loaded'):reject(new Error('Longdo loaded but longdo.Map missing')); };
        s.onerror=()=>{ if(done) return; done=true; clearTimeout(t); reject(new Error('Could not load Longdo API')); };
        document.head.appendChild(s);
      });
    }
    function ensureLeafletAssets(){
      return new Promise((resolve,reject)=>{
        if(window.L&&window.L.map) return resolve('already');
        const css=document.createElement('link'); css.rel='stylesheet'; css.href='https://unpkg.com/leaflet@1.9.4/dist/leaflet.css'; css.integrity='sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY='; css.crossOrigin=''; document.head.appendChild(css);
        const s=document.createElement('script'); s.src='https://unpkg.com/leaflet@1.9.4/dist/leaflet.js'; s.integrity='sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo='; s.crossOrigin=''; s.onload=()=>resolve('loaded'); s.onerror=()=>reject(new Error('Failed to load Leaflet')); document.head.appendChild(s);
      });
    }

    // ===== Engines =====
    const baseMapDict={ SATELLITE:()=>longdo.Layers.SATELLITE, HYBRID:()=>longdo.Layers.HYBRID, NORMAL:()=>longdo.Layers.NORMAL, GRAY:()=>longdo.Layers.GRAY };
    function setLongdoBase(val){ if(mapLD?.Layers?.setBase) mapLD.Layers.setBase(baseMapDict[val]?.()||longdo.Layers.SATELLITE); else if(mapLD?.Layers?.base) mapLD.Layers.base(baseMapDict[val]?.()||longdo.Layers.SATELLITE); }

    function initLongdo(){
      setBadge('Longdo'); engine='longdo';
      mapLD=new longdo.Map({ placeholder:document.getElementById('map'), layer:[longdo.Layers.SATELLITE], zoom:START.zoom, lastView:false, location:{lon:START.lon,lat:START.lat} });
      layerDOL_LD=new longdo.Layer(DOL,{type:longdo.LayerType.WMS,url:WMS,format:'image/png',srs:'EPSG:3857',opacity:0.85});
      mapLD.Event.bind('ready',()=>{ mapLD.Layers.add(layerDOL_LD); setStatus('‚úÖ Longdo ready + DOL overlay.','ok'); });
      mapLD.Event.bind('click', async (evt)=>{
        const lat = evt?.lat ?? evt?.location?.lat ?? mapLD.location().lat;
        const lon = evt?.lon ?? evt?.location?.lon ?? mapLD.location().lon;
        onMapClick(lat,lon,mapLD.zoom?mapLD.zoom():START.zoom);
      });
      mapLD.Event.bind('move', updatePermalink);
      mapLD.Event.bind('zoom', updatePermalink);
    }

    function initLeaflet(){
      setBadge('Leaflet (fallback)'); engine='leaflet';
      mapLF=L.map('map',{preferCanvas:true}).setView([START.lat,START.lon], START.zoom);
      baseLF=L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{maxZoom:19, attribution:'Imagery ¬© Esri'}).addTo(mapLF);
      layerDOL_LF=L.tileLayer.wms(WMS,{layers:DOL,format:'image/png',transparent:true,opacity:0.85}).addTo(mapLF);
      setStatus('‚ÑπÔ∏è Leaflet+Imagery + DOL overlay.','warn');
      mapLF.on('click', e=>onMapClick(e.latlng.lat,e.latlng.lng,mapLF.getZoom()));
      mapLF.on('moveend zoomend', updatePermalink);
    }

    // ===== Core interactions =====
    async function onMapClick(lat,lon,z){
      if(!tracing){
        // If on GFI tab, show info
        if($('#pane-gfi').classList.contains('active')){
          gfiOut.textContent='GFI @ '+lat.toFixed(6)+', '+lon.toFixed(6)+' ‚Ä¶';
          const res=await requestGFI(lon,lat,z);
          gfiOut.textContent = res.ok? ('GFI ('+res.format+'):\\n'+res.body) : ('GFI failed. URL:\\n'+res.url);
        }
        // If clicked on existing polygon?
        const hit = pickParcelAt(lat,lon);
        if(hit){ selectParcel(hit.id); return; }
        return;
      }
      // tracing = true
      let pt={lat,lon};
      if($('#snapToggle').checked){
        const snapped = await snapToRedNear(lat,lon,z);
        if(snapped) pt=snapped;
      }
      tracePts.push(pt);
      drawTrace();
      updateSummaryTemp();
    }

    function drawTrace(){
      if(engine==='leaflet'){
        if(overlayLF){ try{ overlayLF.remove(); }catch{} }
        if(tracePts.length>=2){
          overlayLF=L.polyline(tracePts.map(p=>[p.lat,p.lon]),{color:'#10b981',weight:3}).addTo(mapLF);
        }
      }else if(engine==='longdo'){
        if(overlayLD){ try{ mapLD.Overlays.remove(overlayLD);}catch{} }
        if(tracePts.length>=2){
          overlayLD=new longdo.Polyline(tracePts.map(p=>new longdo.LatLon(p.lat,p.lon)),{lineWidth:3,lineColor:'rgba(16,185,129,1)'});
          mapLD.Overlays.add(overlayLD);
        }
      }
    }
    function drawPolygon(poly){
      if(engine==='leaflet'){
        if(overlayLF){ try{ overlayLF.remove(); }catch{} }
        overlayLF=L.polygon(poly.map(p=>[p.lat,p.lon]),{color:'#10b981',weight:2,fillColor:'#10b981',fillOpacity:.15}).addTo(mapLF);
        // Mask focus
        const rect=clipSvg.getBoundingClientRect();
        const outer=`M0,0 H${rect.width} V${rect.height} H0 Z`;
        const pts=poly.map(p=>mapLF.latLngToContainerPoint([p.lat,p.lon]));
        const inner=pts.map((pt,i)=>(i?'L':'M')+pt.x+','+pt.y).join(' ')+' Z';
        clipPath.setAttribute('d', outer+' '+inner);
      } else if(engine==='longdo'){
        if(overlayLD){ try{ mapLD.Overlays.remove(overlayLD);}catch{} }
        overlayLD=new longdo.Polygon(poly.map(p=>new longdo.LatLon(p.lat,p.lon)),{lineWidth:2,lineColor:'rgba(16,185,129,1)',fillColor:'rgba(16,185,129,0.15)'});
        mapLD.Overlays.add(overlayLD);
      }
    }

    async function snapToRedNear(lat,lon,z){
      // sample around point: small bbox
      const redMin=parseInt($('#redMin').value,10)||180;
      const gMax=parseInt($('#greenMax').value,10)||90;
      const bMax=parseInt($('#blueMax').value,10)||90;
      const isRed=(r,g,b)=> (r>=redMin && g<=gMax && b<=bMax);
      const px=128, py=128;
      const mpp = metersPerPixelAtLat(lat, Math.max(16,z));
      const span = Math.max(20, Math.min(120, Math.round(40*mpp))); // meters half-span
      const M = lonLatToMerc({lon,lat});
      const bbox=[M.x-span, M.y-span, M.x+span, M.y+span];
      const url=WMS+'?SERVICE=WMS&VERSION=1.1.1&REQUEST=GetMap&LAYERS='+encodeURIComponent(DOL)+'&SRS=EPSG:3857&STYLES=&BBOX='+bbox.map(v=>v.toFixed(3)).join(',')+'&WIDTH='+px+'&HEIGHT='+py+'&FORMAT=image/png&TRANSPARENT=true&_t='+Date.now();
      try{
        const img=await loadImage(url);
        const cvs=document.createElement('canvas'); cvs.width=px; cvs.height=py;
        const ctx=cvs.getContext('2d');
        ctx.drawImage(img,0,0);
        const data=ctx.getImageData(0,0,px,py);
        const p=mercToPixel(M,bbox,px,py);
        const q=findNearestRed(data,p.x,p.y,isRed);
        if(q){
          const merc=pixelToMerc(q.x,q.y,bbox,px,py);
          return mercToLonLat(merc);
        }
      }catch(e){}
      return null;
    }
    function loadImage(src){ return new Promise((resolve,reject)=>{ const img=new Image(); img.crossOrigin='anonymous'; img.onload=()=>resolve(img); img.onerror=()=>reject(new Error('WMS image load failed')); img.src=src; }); }
    function mercToPixel({x,y},bbox,w,h){ const [minx,miny,maxx,maxy]=bbox; const px=(x-minx)/(maxx-minx)*w; const py=(maxy-y)/(maxy-miny)*h; return {x:Math.round(px), y:Math.round(py)}; }
    function pixelToMerc(px,py,bbox,w,h){ const [minx,miny,maxx,maxy]=bbox; const x=minx+(px/w)*(maxx-minx); const y=maxy-(py/h)*(maxy-miny); return {x,y}; }
    function findNearestRed(img, cx, cy, isRed){
      const {data,width,height}=img;
      const idx=(x,y)=>(y*width+x)*4;
      const inside=(x,y)=>x>=0&&y>=0&&x<width&&y<height;
      let best=null, bestD=1e9;
      const R=20;
      for(let dy=-R; dy<=R; dy++){
        for(let dx=-R; dx<=R; dx++){
          const x=cx+dx, y=cy+dy; if(!inside(x,y)) continue;
          const i=idx(x,y); const r=data[i],g=data[i+1],b=data[i+2],a=data[i+3];
          if(a>0 && isRed(r,g,b)){ const d=dx*dx+dy*dy; if(d<bestD){ bestD=d; best={x,y}; } }
        }
      }
      return best;
    }

    function finishTrace(){
      if(tracePts.length<3){ alert('‡∏¢‡∏±‡∏á‡∏ß‡∏≤‡∏î‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö'); return; }
      // Close polygon if not closed
      const first=tracePts[0], last=tracePts[tracePts.length-1];
      const close=(Math.hypot(first.lat-last.lat, first.lon-last.lon)<1e-6);
      const poly = close? tracePts.slice() : tracePts.concat([first]);
      drawPolygon(poly);
      tracing=false;
      // compute area
      const areaM2=polyAreaMeters2(poly);
      const wah=Math.round(areaM2/4);
      $('#f-area').value = wah;
      // frontage suggestions (edges list)
      renderEdges(poly);
      // create unsaved parcel in summary
      const id = selectedId || uid();
      selectedId = id;
      parcelSummary.textContent = `ID: ${id} ‚Ä¢ ‡∏û‡∏ó.~ ${wah} ‡∏ï‡∏£.‡∏ß‡∏≤ ‚Ä¢ ‡∏à‡∏∏‡∏î: ${poly.length}`;
    }

    function renderEdges(poly){
      edgesEl.innerHTML='';
      if(!poly || poly.length<2) return;
      const edges=[];
      for(let i=0;i<poly.length-1;i++){ edges.push({i, a:poly[i], b:poly[i+1], len:distMeters(poly[i],poly[i+1])}); }
      edges.sort((x,y)=>y.len-x.len);
      edges.forEach((e,idx)=>{
        const b=document.createElement('button');
        b.className='edge'+(frontageIdx===e.i?' selected':'');
        b.textContent=`E${e.i} ‚Ä¢ ${e.len.toFixed(1)} m`;
        b.addEventListener('click',()=>{
          frontageIdx=e.i;
          $('#f-width').value = e.len.toFixed(1);
          renderEdges(poly);
        });
        edgesEl.appendChild(b);
      });
    }

    // ===== Parcels =====
    function selectParcel(id){
      const p=store.byId(id); if(!p) return;
      selectedId=id;
      parcelSummary.textContent=`ID: ${p.id} ‚Ä¢ ${p.areaSqWah||'-'} ‡∏ï‡∏£.‡∏ß‡∏≤`;
      $('#f-area').value=p.areaSqWah||'';
      $('#f-width').value=p.widthM||'';
      $('#f-owner').value=p.ownerName||'';
      $('#f-phone').value=p.phone||'';
      $('#f-line').value=p.line||'';
      // draw polygon
      if(p.geometry){
        if(engine==='leaflet'){
          if(overlayLF){ try{ overlayLF.remove(); }catch{} }
          overlayLF=L.polygon(p.geometry.map(g=>[g.lat,g.lon]),{color:'#10b981',weight:2,fillColor:'#10b981',fillOpacity:.15}).addTo(mapLF);
        }else if(engine==='longdo'){
          if(overlayLD){ try{ mapLD.Overlays.remove(overlayLD);}catch{} }
          overlayLD=new longdo.Polygon(p.geometry.map(g=>new longdo.LatLon(g.lat,g.lon)),{lineWidth:2,lineColor:'rgba(16,185,129,1)',fillColor:'rgba(16,185,129,0.15)'});
          mapLD.Overlays.add(overlayLD);
        }
      }
      renderList();
    }

    function renderList(){
      const Ls=store.list();
      parcelList.innerHTML='';
      if(!Ls.length){ parcelList.innerHTML='<div class="small muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏õ‡∏•‡∏á</div>'; return; }
      for(const p of Ls){
        const canShow = p.permission==='granted' && (p.viewerUnlockedPII===true);
        const el=document.createElement('div');
        el.className='card';
        el.innerHTML=`
          <div class="row" style="justify-content:space-between">
            <div><b>${p.id}</b> ‚Ä¢ ‡∏û‡∏ó.: ${p.areaSqWah||'-'} ‡∏ï‡∏£.‡∏ß‡∏≤ ‚Ä¢ ‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏ß‡πâ‡∏≤‡∏á: ${p.widthM||'-'} ‡∏°.</div>
            <div><button class="btn small" data-act="select" data-id="${p.id}">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button></div>
          </div>
          <div class="small">‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á: <span class="${canShow?'':'masked'}">${p.ownerName||'-'}</span></div>
          <div class="small">‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠: <span class="${canShow?'':'masked'}">${p.phone||p.line||'-'}</span></div>
          <div class="row">
            <button class="btn small" data-act="perm" data-id="${p.id}">${p.permission==='granted'?'‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÅ‡∏•‡πâ‡∏ß':'‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ú‡∏¢'}</button>
            <button class="btn small" data-act="chat" data-id="${p.id}">‡πÅ‡∏ä‡∏ó</button>
            <button class="btn small danger" data-act="del" data-id="${p.id}">‡∏•‡∏ö</button>
          </div>
        `;
        parcelList.appendChild(el);
      }
      parcelList.querySelectorAll('button').forEach(btn=>{
        const id=btn.getAttribute('data-id'); const act=btn.getAttribute('data-act');
        btn.addEventListener('click',()=>{
          if(act==='select') selectParcel(id);
          else if(act==='perm') requestPerm(id);
          else if(act==='chat') openChat(id);
          else if(act==='del'){ const L=store.list().filter(x=>x.id!==id); store.save(L); if(selectedId===id) selectedId=null; renderList(); }
        });
      });
    }

    function saveCurrentParcel(){
      if(!overlayLF && !overlayLD && !tracePts.length){ alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏ó‡∏£‡∏á'); return; }
      const id = selectedId || uid();
      let geometry = tracePts.length? tracePts.slice() : null;
      if(!geometry){
        // try to read from overlay polygon (leaflet only)
        if(engine==='leaflet' && overlayLF && overlayLF.getLatLngs){
          const latlngs=overlayLF.getLatLngs()[0]||overlayLF.getLatLngs();
          geometry = latlngs.map(ll=>({lat:ll.lat, lon:ll.lng}));
        }
      }
      if(!geometry || geometry.length<3){ alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏ó‡∏£‡∏á'); return; }
      const center = (function(){
        let sx=0,sy=0; geometry.forEach(p=>{ sx+=p.lat; sy+=p.lon;}); return {lat:sx/geometry.length, lon:sy/geometry.length};
      })();
      const areaSqWah = parseFloat($('#f-area').value||'0')||null;
      const widthM = parseFloat($('#f-width').value||'0')||null;
      const p = {
        id, center, geometry, areaSqWah, widthM,
        ownerName: ($('#f-owner').value||'').trim(),
        phone: ($('#f-phone').value||'').trim(),
        line: ($('#f-line').value||'').trim(),
        permission: store.byId(id)?.permission || 'private',
        chatUnlocked: store.byId(id)?.chatUnlocked || false,
        viewerUnlockedPII: store.byId(id)?.viewerUnlockedPII || false
      };
      store.upsert(p);
      selectedId=id;
      renderList();
      parcelSummary.textContent=`ID: ${id} ‚Ä¢ ${areaSqWah||'-'} ‡∏ï‡∏£.‡∏ß‡∏≤`;
      alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏õ‡∏•‡∏á‡πÅ‡∏•‡πâ‡∏ß');
    }

    function requestPerm(id){
      const p=store.byId(id); if(!p) return;
      if(p.permission==='granted'){ alert('‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÅ‡∏•‡πâ‡∏ß'); return; }
      p.permission='pending'; store.upsert(p); renderList(); alert('‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÅ‡∏•‡πâ‡∏ß (‡∏à‡∏≥‡∏•‡∏≠‡∏á)');
    }
    function simulateApprove(id){
      const p=store.byId(id)||{id,permission:'private'};
      p.permission='granted'; store.upsert(p); renderList(); alert('[‡πÄ‡∏î‡πÇ‡∏°] ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    }

    function openChat(id){
      const p=store.byId(id||selectedId); if(!p){ alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏õ‡∏•‡∏á'); return; }
      if(!p.chatUnlocked){
        if(store.coins<CHAT_COST){ alert('‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡πÑ‡∏°‡πà‡∏û‡∏≠ ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ '+CHAT_COST+' coins'); return; }
        if(!confirm('‡πÉ‡∏ä‡πâ '+CHAT_COST+' coins ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ä‡∏ó‡∏ô‡∏µ‡πâ?')) return;
        store.coins = store.coins - CHAT_COST;
        p.chatUnlocked=true; store.upsert(p); updateCoins();
      }
      alert('[‡πÄ‡∏î‡πÇ‡∏°] ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÅ‡∏ä‡∏ó‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏õ‡∏•‡∏á '+p.id);
    }

    function viewPII(id){
      const p=store.byId(id||selectedId); if(!p){ alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏õ‡∏•‡∏á'); return; }
      if(p.permission!=='granted'){ alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ú‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•'); return; }
      if(!p.viewerUnlockedPII){
        if(store.coins<PII_COST){ alert('‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡πÑ‡∏°‡πà‡∏û‡∏≠ ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ '+PII_COST+' coins'); return; }
        if(!confirm('‡πÉ‡∏ä‡πâ '+PII_COST+' coins ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß?')) return;
        store.coins = store.coins - PII_COST;
        p.viewerUnlockedPII=true; store.upsert(p); updateCoins();
      }
      renderList();
      alert('‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏•‡πâ‡∏ß');
    }

    function pickParcelAt(lat,lon){
      const Ls=store.list();
      return Ls.find(p=>pointInPoly({lat,lon}, p.geometry||[]))||null;
    }
    function pointInPoly(point, poly){
      let x=point.lon,y=point.lat, inside=false;
      for(let i=0,j=poly.length-1;i<poly.length;j=i++){
        const xi=poly[i].lon, yi=poly[i].lat;
        const xj=poly[j].lon, yj=poly[j].lat;
        const intersect=((yi>y)!=(yj>y)) && (x < (xj-xi)*(y-yi)/(yj-yi)+xi);
        if(intersect) inside=!inside;
      }
      return inside;
    }

    // ===== GFI =====
    async function requestGFI(lon, lat, zoom){
      const mpp=(156543.03392804097*Math.cos(toRad(lat)))/Math.pow(2, zoom||START.zoom);
      const r=Math.max(5, Math.min(50, Math.round(10*mpp)));
      const pt=lonLatToMerc({lon,lat});
      const bbox=[(pt.x-r).toFixed(3),(pt.y-r).toFixed(3),(pt.x+r).toFixed(3)].join(',');
      const base=WMS+'?SERVICE=WMS&VERSION=1.1.1&REQUEST=GetFeatureInfo'
        +'&LAYERS='+encodeURIComponent(DOL)+'&QUERY_LAYERS='+encodeURIComponent(DOL)
        +'&SRS=EPSG:3857&STYLES='
        +'&BBOX='+bbox+'&WIDTH=101&HEIGHT=101&X=50&Y=50&FEATURE_COUNT=10';
      const fmts=['application/json','text/plain','text/html','text/xml'];
      for(const fmt of fmts){
        const url=base+'&INFO_FORMAT='+encodeURIComponent(fmt)+'&_t='+Date.now();
        try{ const res=await fetch(url,{mode:'cors'}); if(!res.ok) continue; let text=await res.text(); if(fmt==='application/json'){ try{ text=JSON.stringify(JSON.parse(text),null,2);}catch{} } return {ok:true, url, body:text, format:fmt}; }catch(e){}
      }
      const fallback=base+'&INFO_FORMAT='+encodeURIComponent('text/plain')+'&_t='+Date.now();
      return {ok:false, url:fallback, body:''};
    }

    // ===== Permalink =====
    function currentView(){
      if(engine==='longdo'&&mapLD){ const loc=mapLD.location(); const z=mapLD.zoom?mapLD.zoom():START.zoom; return {lat:loc.lat, lon:loc.lon, zoom:z}; }
      if(engine==='leaflet'&&mapLF){ const c=mapLF.getCenter(); return {lat:c.lat, lon:c.lng, zoom:mapLF.getZoom()}; }
      return {...START};
    }
    function updatePermalink(){
      const v=currentView();
      const p=new URLSearchParams();
      p.set('e',engine||'');
      p.set('lat',v.lat.toFixed(6)); p.set('lon',v.lon.toFixed(6)); p.set('z',v.zoom);
      p.set('base',$('#baseSel').value);
      p.set('op',(parseInt($('#opacity').value,10)/100).toFixed(2));
      p.set('dol',$('#toggleDol').checked?'1':'0');
      const L=store.list().map(x=>x.id); if(L.length) p.set('ids', L.join(','));
      history.replaceState(null,'','#'+p.toString());
      $('#permalink').value = location.origin + location.pathname + '#' + p.toString();
    }
    function restoreFromHash(){
      if(!location.hash||location.hash.length<=1) return;
      const p=new URLSearchParams(location.hash.slice(1));
      if(p.get('base')) $('#baseSel').value=p.get('base');
      if(p.get('op')){ const op=Math.max(0,Math.min(1,parseFloat(p.get('op')))); $('#opacity').value=Math.round(op*100); $('#opv').textContent=op.toFixed(2); }
      if(p.get('dol')) $('#toggleDol').checked=p.get('dol')==='1';
    }

    // ===== UI events =====
    function updateCoins(){ coinBal.textContent=store.coins; }
    $('#buyCoins').addEventListener('click',()=>{ store.coins = store.coins + 20; updateCoins(); });
    $('#openChat').addEventListener('click',()=>openChat(selectedId));
    $('#viewPII').addEventListener('click',()=>viewPII(selectedId));

    $('#tab-parcels').addEventListener('click',()=>{ setTab('parcels'); });
    $('#tab-gfi').addEventListener('click',()=>{ setTab('gfi'); });
    $('#tab-log').addEventListener('click',()=>{ setTab('log'); });
    function setTab(name){
      ['parcels','gfi','log'].forEach(t=>{
        $('#tab-'+t).classList.toggle('active', t===name);
        $('#pane-'+t).classList.toggle('active', t===name);
      });
    }

    $('#centerBkk').addEventListener('click',()=>{
      if(engine==='longdo'){ mapLD.location({lon:START.lon,lat:START.lat},true); mapLD.zoom(START.zoom,true); }
      else if(engine==='leaflet'){ mapLF.setView([START.lat,START.lon], START.zoom, {animate:true}); }
      updatePermalink();
    });
    $('#reloadApi').addEventListener('click', async ()=>{
      setStatus('Reloading Longdo‚Ä¶');
      try{ await loadLongdoScript(KEY); setStatus('‚úî Longdo loaded.','ok'); if(mapLF){ mapLF.remove(); mapLF=null; } initLongdo(); }catch(e){ setStatus('‚ùå '+e.message+' ‚Äî stay fallback','err'); if(!mapLF){ try{ await ensureLeafletAssets(); initLeaflet(); }catch(le){ setStatus('‚ùå Leaflet failed: '+le.message,'err'); } } }
      updatePermalink();
    });

    $('#baseSel').addEventListener('change',(e)=>{
      const val=e.target.value;
      if(engine==='longdo') setLongdoBase(val);
      else if(engine==='leaflet'){
        if(baseLF) mapLF.removeLayer(baseLF);
        if(val==='SATELLITE'||val==='HYBRID')
          baseLF=L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{maxZoom:19, attribution:'Imagery ¬© Esri'});
        else
          baseLF=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap contributors'});
        baseLF.addTo(mapLF);
      }
      updatePermalink();
    });
    $('#toggleDol').addEventListener('change',(e)=>{
      if(engine==='longdo'){ if(e.target.checked) mapLD.Layers.add(layerDOL_LD); else mapLD.Layers.remove(layerDOL_LD); }
      else if(engine==='leaflet'){ if(e.target.checked) layerDOL_LF.addTo(mapLF); else mapLF.removeLayer(layerDOL_LF); }
      updatePermalink();
    });
    $('#opacity').addEventListener('input',(e)=>{
      const v=parseInt(e.target.value,10)/100; $('#opv').textContent=v.toFixed(2);
      if(engine==='longdo'){ if(layerDOL_LD) mapLD.Layers.remove(layerDOL_LD); layerDOL_LD=new longdo.Layer(DOL,{type:longdo.LayerType.WMS,url:WMS,format:'image/png',srs:'EPSG:3857',opacity:v}); if($('#toggleDol').checked) mapLD.Layers.add(layerDOL_LD); }
      else if(engine==='leaflet'){ if(layerDOL_LF?.setOpacity) layerDOL_LF.setOpacity(v); }
      updatePermalink();
    });

    $('#startTrace').addEventListener('click',()=>{ tracing=true; tracePts=[]; frontageIdx=null; setStatus('‡πÇ‡∏´‡∏°‡∏î‡∏ß‡∏≤‡∏î: ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ï‡∏≤‡∏°‡∏Ç‡∏≠‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡πÅ‡∏î‡∏á‡∏ó‡∏µ‡∏•‡∏∞‡∏à‡∏∏‡∏î ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î Finish','ok'); });
    $('#finishTrace').addEventListener('click', finishTrace);
    $('#clearSel').addEventListener('click',()=>{
      tracing=false; tracePts=[]; frontageIdx=null;
      if(engine==='leaflet'){ if(overlayLF){ overlayLF.remove(); overlayLF=null; } clipPath.setAttribute('d',''); }
      else if(engine==='longdo'){ if(overlayLD){ mapLD.Overlays.remove(overlayLD); overlayLD=null; } }
      parcelSummary.textContent='‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏î/‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏õ‡∏•‡∏á';
    });

    $('#saveParcel').addEventListener('click', saveCurrentParcel);
    $('#reqPerm').addEventListener('click',()=>{ if(!selectedId) selectedId=uid(); requestPerm(selectedId); });
    $('#simApprove').addEventListener('click',()=>{ if(!selectedId) selectedId=uid(); simulateApprove(selectedId); });

    $('#copyLink').addEventListener('click',async()=>{ updatePermalink(); try{ await navigator.clipboard.writeText($('#permalink').value); log('Permalink copied','ok'); }catch{ log('Copy failed','warn'); } });

    $('#runChecks').addEventListener('click',()=>{
      const msgs=[]; msgs.push('engine: '+(engine||'none')); msgs.push(window.longdo?'longdo: OK':'longdo: MISSING'); msgs.push(window.longdo?.Map?'longdo.Map: OK':'longdo.Map: MISSING');
      msgs.push(mapLD?'mapLD: OK':'mapLD: MISSING'); msgs.push(layerDOL_LD?'DOL(longdo): OK':'DOL(longdo): MISSING');
      msgs.push(window.L?'Leaflet: OK':'Leaflet: MISSING'); msgs.push(mapLF?'mapLF: OK':'mapLF: MISSING'); msgs.push(layerDOL_LF?'DOL(leaflet): OK':'DOL(leaflet): MISSING');
      setStatus(msgs.join('\\n'), (msgs.some(m=>/MISSING/.test(m))?'warn':'ok'));
    });
    $('#testWms').addEventListener('click',()=>{
      const bbox=[11131949.08,1549654.80,11203509.67,1625506.22];
      const src=WMS+'?SERVICE=WMS&VERSION=1.1.1&REQUEST=GetMap&LAYERS='+encodeURIComponent(DOL)+'&SRS=EPSG:3857&BBOX='+bbox.join(',')+'&WIDTH=512&HEIGHT=512&FORMAT=image/png&TRANSPARENT=true&_t='+Date.now();
      const img=new Image(); img.onload=()=>setStatus('üü¢ WMS GetMap OK','ok'); img.onerror=()=>setStatus('üî¥ WMS GetMap FAILED','err'); img.src=src;
    });

    function updateSummaryTemp(){
      if(tracePts.length<2){ parcelSummary.textContent='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏≤‡∏î‚Ä¶ ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏à‡∏∏‡∏î‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏ï‡∏≤‡∏°‡∏Ç‡∏≠‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡πÅ‡∏î‡∏á'; return; }
      const meters = tracePts.slice(1).reduce((s,p,i)=>s+distMeters(tracePts[i],p),0);
      parcelSummary.textContent='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏≤‡∏î‚Ä¶ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡πÄ‡∏™‡πâ‡∏ô‡∏£‡∏ß‡∏° ~ '+meters.toFixed(1)+' m';
    }

    // ===== Boot =====
    function updateCoins(){ coinBal.textContent=store.coins; }
    window.addEventListener('error', e=>log('window.onerror: '+(e?.message||'unknown'),'err'));
    window.addEventListener('unhandledrejection', e=>log('unhandledrejection: '+(e?.reason?.message||e?.reason||'unknown'),'err'));
    (async function boot(){
      updateCoins(); renderList(); restoreFromHash();
      setStatus('Loading Longdo API‚Ä¶');
      try{ await loadLongdoScript(KEY); log('‚úî Longdo loaded.','ok'); initLongdo(); }
      catch(err){ setStatus('‚ùå '+err.message+' ‚Üí fallback Leaflet','warn'); try{ await ensureLeafletAssets(); initLeaflet(); }catch(le){ setStatus('‚ùå Leaflet failed: '+le.message,'err'); } }
      updatePermalink();
    })();
  })();
  </script>
</body>
</html>
